---
title: iceberg基础知识
tags: [iceberg]
---

##  iceberg定义

Doc: https://iceberg.apache.org/docs/latest/

```
Apache Iceberg is an open table format for huge analytic datasets.
```

官方把iceberg定义为针对大数据分析的表格式定义。 

一张数据表主要包含两个主要内容： Schema + Data. 

当前比较流行的Hive，把schema和data进行了分别存储。 schema信息存储在mysql等关系型数据库里，并通过Location属性指向数据真实的存储位置。

Hive通过schema与data的分别存储，好处是数据存储可以使用多种存储类型或多个存储集群。坏处是无法保证事务。


iceberg则将schema和data统一存储在一处，方便进行事务管理等。 

### Hive 表存在的问题

 - 由于 Hive 表格式只保存了数据文件的目录，所以在文件切分前会使用文件系统的 list 操作，列出所有的数据文件。容易对HDFS等存储集群造成压力
 - 无法保证数据生产的事务
    数据生产时，结果存储在临时路径下。 计算结束后，通过操作系统的rename操作放到指定目录下。 
    多任务同时写一个目录时，会造成某一任务的目录被强制覆盖，无法保证任务的一致性。
 - schema集中存储在mysql等关系数据库中，性能容易成为瓶颈。
 - Hive的schema中，统计信息非强制写入且统计信息的力度很粗。导致sql在生成planer中，很难做到剪裁和优化。
 - 不支持更新、删除操作。需要时，只能进行全表覆盖。


## iceberg 文件目录结构

### iceberg 数据生成。 

 1. 下载并搭建spark环境，执行spark-sql命令

    ```
    spark-sql --packages org.apache.iceberg:iceberg-spark-runtime-3.2_2.12:0.13.1\
        --conf spark.sql.extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions \
        --conf spark.sql.catalog.spark_catalog=org.apache.iceberg.spark.SparkSessionCatalog \
        --conf spark.sql.catalog.spark_catalog.type=hive \
        --conf spark.sql.catalog.local=org.apache.iceberg.spark.SparkCatalog \
        --conf spark.sql.catalog.local.type=hadoop \
        --conf spark.sql.catalog.local.warehouse=$PWD/warehouse
    ```
 2. 创建iceberg格式的表
    ```
    create table local.db.table(id bigint, data string) using iceberg
    ```
 3. 插入数据
    ```
    INSERT INTO local.db.table VALUES (1, 'a'), (2, 'b'), (3, 'c');
    INSERT INTO local.db.table VALUES (4, 'd');
    delete from  local.db.table where id=1
    delete from  local.db.table where id=1
    delete from  local.db.table where id=1
    ```
### iceberg表目录

执行完上述操作之后，最终生成的目录结构如下图所示

文件类型主要分为三类：
 1. data/ 数据文件，普通的parquet文件，存放写入的数据
 2. metadata/下avro和json类型的文件，
 3. catalog(version-hint.txt文件)，只有使用hadoop catalog才会有此文件

![Iceberg 文件组织结构图](/images/bigdata/iceberg-filedir.png)


### Iceberg整体文件架构

上面的元数据文件之间是什么关系，我们结合Iceberg的文件系统架构进行简单介绍。 

![](/images/bigdata/iceberg-fielsystem.webp)

#### catalog

Iceberg 文件组织结构图中 version-hint.txt 文件，使用 Hadoop Catalog 才会生成此文件。由于表的 schema 和统计信息已经保存在 metadata.josn 文件中， catalog 比较轻量，只需要保存 Iceberg 表最新的 metadata.json 文件的存储路径。

Iceberg 当前支持的catalog：
 - Hive Metastore
 - Hadoop (只要提供原子的 rename 操作的文件系统都可以)
 - JDBC

#### metadata file

Iceberg 文件组织结构图中 的 json 文件，每次提交表的时候生成一个，上面一共有 6 个 metadata.json 文件，创建表的时候生成一个，每 insert/delete 一次生成一个。包含的信息主要有：

 1. 当前表的 schema 信息和历史的 schema 信息。
 2. 表的提交历史（快照）和当前快照ID。快照中包含当前表的一些统计信息，例如文件总大小，文件个数，总行数。
 3. 文件路径、分区等其它信息。

#### manifestlist file 

Iceberg 文件组织结构图中以 metadata/snap- 开头的 avro 文件。 manifestlist file 的内容 和 manifest file 文件很相似，不同的是 manifestlist file 是对 manifest file 文件的索引，一个快照只能有一个 manifestlist file 文件。每个manifestlist file包含多个manifest file记录。 

| 字段 | 作用 |
|----| ----|
| manifest_path | manifest file 文件路径 |
| partitions | 该manifest file文件包含的partition |
|added_rows_count| manifest file 增加的rows数 |
|delete_rows_count| manifest file 删除的rows数 |

#### manifest file
manifest file，Iceberg 文件组织结构图 metadata下121b7ee3等开头的avro文件。

一个manifest file可以索引多个数据文件。 通过avro-tools工具查看
![](/images/bigdata/iceberg-manifest.png)

一个 manifest file 可以索引多个数据文件，在 manifest file 文件中一行索引一个数据文件，例如第一行，表示 00000-0-dadd7fd1-a21a-4190-a181-5ce67aa38505-00001.parquet.parquet 所属的分区，每一列的最大值和最小值。
还有一些其它信息，如文件大小，文件行数，null 值行数等信息，这里没有做详细的展示。默认一个 manifest file 文件大小是 8M。

| 字段 | 作用 |
|----|-----|
| snapshot_id | 当前manifst file生成的snap id |
| data_file[].file_path | 数据文件路径 |
| data_file[].file_format| 数据文件格式，支持parquet\orc\avro |
| data_file[].lower_bounds| 各子段的最小值 |
| data_file[].upper_bounds| 各字段的最大值 |
| data_file[].null_value_counts| 各字段的null值计数 |
| data_file[].value_counts| 标记各字段的值的去重数，count(distinct()) |


### 数据生成过程

 - 一次insert、delete等操作会生成一个metadata.json文件。 

 - 该文件中包含当前对应的snapshot的id.

 - 一个snapshot的id对应一个manifestlist file文件，也就是snap-*.avro文件。 

 - manifestlist file文件中会包含与当前snapshot所有有关的manifest file文件列表。 

 - 每个manifest file对应一个snapshot id。表示该manifest file是生成自哪一个snapshot。如果manifest file文件中的snapshot id等于当前manifestlist file文件中的snapshot id，则表示该manifest file文件本次操作有修改。 否则表明该manifest file文件继承自之前的snapshot。

